import { TestBed, async, inject } from "@angular/core/testing";
import { WarcraftLogsDeathService } from "./warcraft-logs-death.service";
import { Http, HttpModule, XHRBackend, Response, ResponseOptions } from "@angular/http";
import { MockBackend, MockConnection } from "@angular/http/testing";
import { Report, FightInfo } from "../reports/report";

describe("WarcraftLogsDeathService", () => {
    const url = "https://www.warcraftlogs.com/v1/";
    const apiKey = "4755ffa6214768b13beab7deb1bfc85f";

    beforeEach(async(() => {
        TestBed.configureTestingModule({
            imports: [HttpModule],
            providers: [
                { provide: XHRBackend, useClass: MockBackend }
            ]
        });
    }));

    it("should return deaths", async(inject([XHRBackend, Http], (mockBackend: MockBackend, http) => {
        var report = {
            id: "xyMd2kwb3W9zNrJF"
        } as Report;
        var fightInfo = {
            start_time: 2313891,
            end_time: 2724731
        } as FightInfo;

        var expectedResponse = JSON.parse(
            '{\r\n    "entries": [\r\n        {\r\n            "name": "Heskeey",\r\n            "id": 9,\r\n            "guid": 102448599,\r\n            "type": "Hunter",\r\n            "icon": "Hunter-BeastMastery",\r\n            "timestamp": 2364324,\r\n            "damage": {\r\n                "total": 10355460,\r\n                "activeTime": 0,\r\n                "activeTimeReduced": 0,\r\n                "abilities": [\r\n                    {\r\n                        "name": "Chaos Pulse",\r\n                        "total": 3371281,\r\n                        "type": 4\r\n                    },\r\n                    {\r\n                        "name": "Shocked",\r\n                        "total": 3273059,\r\n                        "type": 4\r\n                    },\r\n                    {\r\n                        "name": "Entropic Blast",\r\n                        "total": 2035696,\r\n                        "type": 4\r\n                    },\r\n                    {\r\n                        "name": "Shock Grenade",\r\n                        "total": 1675424,\r\n                        "type": 4\r\n                    }\r\n                ],\r\n                "damageAbilities": [],\r\n                "sources": [\r\n                    {\r\n                        "name": "Environment",\r\n                        "total": 3273059,\r\n                        "type": "NPC"\r\n                    },\r\n                    {\r\n                        "name": "General Erodus",\r\n                        "total": 2339289,\r\n                        "type": "NPC"\r\n                    },\r\n                    {\r\n                        "name": "Entropic Mine",\r\n                        "total": 2035696,\r\n                        "type": "NPC"\r\n                    },\r\n                    {\r\n                        "name": "Admiral Svirax",\r\n                        "total": 1675424,\r\n                        "type": "Boss"\r\n                    },\r\n                    {\r\n                        "name": "Chief Engineer Ishkar",\r\n                        "total": 1031992,\r\n                        "type": "NPC"\r\n                    }\r\n                ]\r\n            },\r\n            "healing": {\r\n                "total": 3138199,\r\n                "activeTime": 0,\r\n                "activeTimeReduced": 0,\r\n                "abilities": [\r\n                    {\r\n                        "name": "Shadowbind",\r\n                        "total": 741306,\r\n                        "type": 32\r\n                    },\r\n                    {\r\n                        "name": "Spirit Bond",\r\n                        "total": 594391,\r\n                        "type": 8\r\n                    },\r\n                    {\r\n                        "name": "Dreamer",\r\n                        "total": 316309,\r\n                        "type": 8\r\n                    },\r\n                    {\r\n                        "name": "Velen\'s Future Sight",\r\n                        "total": 312690,\r\n                        "type": 2\r\n                    },\r\n                    {\r\n                        "name": "Echo of Light",\r\n                        "total": 280601,\r\n                        "type": 2\r\n                    }\r\n                ],\r\n                "damageAbilities": [\r\n                    {\r\n                        "name": "Chaos Pulse",\r\n                        "total": 1517491,\r\n                        "type": 4\r\n                    },\r\n                    {\r\n                        "name": "Entropic Blast",\r\n                        "total": 990099,\r\n                        "type": 4\r\n                    },\r\n                    {\r\n                        "name": "Shock Grenade",\r\n                        "total": 630609,\r\n                        "type": 4\r\n                    }\r\n                ],\r\n                "sources": [\r\n                    {\r\n                        "name": "Heskeey",\r\n                        "total": 1449572,\r\n                        "type": "Hunter"\r\n                    },\r\n                    {\r\n                        "name": "Flucloxx",\r\n                        "total": 1060822,\r\n                        "type": "Druid"\r\n                    },\r\n                    {\r\n                        "name": "Vanyal\\u00ed",\r\n                        "total": 585836,\r\n                        "type": "Priest"\r\n                    },\r\n                    {\r\n                        "name": "X\\u00e9nubis",\r\n                        "total": 41969,\r\n                        "type": "Paladin"\r\n                    }\r\n                ]\r\n            },\r\n            "fight": 13,\r\n            "deathWindow": 9377,\r\n            "overkill": 555581,\r\n            "events": [\r\n                {\r\n                    "timestamp": 2364324,\r\n                    "type": "damage",\r\n                    "source": {\r\n                        "name": "Environment",\r\n                        "id": -1,\r\n                        "guid": 0,\r\n                        "type": "NPC",\r\n                        "icon": "NPC-warcraft-0"\r\n                    },\r\n                    "sourceIsFriendly": false,\r\n                    "targetID": 9,\r\n                    "targetIsFriendly": true,\r\n                    "ability": {\r\n                        "name": "Shocked",\r\n                        "guid": 244748,\r\n                        "type": 4,\r\n                        "abilityIcon": "ability_monk_cracklingjadelightning.jpg"\r\n                    },\r\n                    "hitType": 1,\r\n                    "amount": 2717478,\r\n                    "overkill": 555581,\r\n                    "absorbed": 0\r\n                },\r\n                {\r\n                    "timestamp": 2364213,\r\n                    "type": "damage",\r\n                    "sourceID": 107,\r\n                    "sourceInstance": 1,\r\n                    "sourceIsFriendly": false,\r\n                    "targetID": 9,\r\n                    "targetIsFriendly": true,\r\n                    "ability": {\r\n                        "name": "Chaos Pulse",\r\n                        "guid": 257974,\r\n                        "type": 4,\r\n                        "abilityIcon": "spell_fire_felpyroblast.jpg"\r\n                    },\r\n                    "hitType": 1,\r\n                    "amount": 258739,\r\n                    "absorbed": 0\r\n                },\r\n                {\r\n                    "timestamp": 2363666,\r\n                    "type": "damage",\r\n                    "sourceID": 107,\r\n                    "sourceInstance": 1,\r\n                    "sourceIsFriendly": false,\r\n                    "targetID": 9,\r\n                    "targetIsFriendly": true,\r\n                    "ability": {\r\n                        "name": "Chaos Pulse",\r\n                        "guid": 257974,\r\n                        "type": 4,\r\n                        "abilityIcon": "spell_fire_felpyroblast.jpg"\r\n                    },\r\n                    "hitType": 1,\r\n                    "amount": 253894,\r\n                    "absorbed": 0\r\n                }\r\n            ],\r\n            "killingBlow": {\r\n                "name": "Shocked",\r\n                "guid": 244748,\r\n                "type": 4,\r\n                "abilityIcon": "ability_monk_cracklingjadelightning.jpg"\r\n            }\r\n        },\r\n        {\r\n            "name": "Raek\\u00f3n",\r\n            "id": 5,\r\n            "guid": 84896926,\r\n            "type": "Priest",\r\n            "icon": "Priest-Shadow",\r\n            "timestamp": 2396635,\r\n            "damage": {\r\n                "total": 12692238,\r\n                "totalReduced": 12436348,\r\n                "activeTime": 0,\r\n                "activeTimeReduced": 0,\r\n                "abilities": [\r\n                    {\r\n                        "name": "Entropic Blast",\r\n                        "total": 6105742,\r\n                        "type": 4\r\n                    },\r\n                    {\r\n                        "name": "Shocked",\r\n                        "total": 3289698,\r\n                        "type": 4\r\n                    },\r\n                    {\r\n                        "name": "Shock Grenade",\r\n                        "total": 1674753,\r\n                        "totalReduced": 1418863,\r\n                        "type": 4\r\n                    },\r\n                    {\r\n                        "name": "Entropic Blast",\r\n                        "total": 1622045,\r\n                        "type": 4\r\n                    }\r\n                ],\r\n                "damageAbilities": [],\r\n                "sources": [\r\n                    {\r\n                        "name": "Entropic Mine",\r\n                        "total": 7727787,\r\n                        "type": "NPC"\r\n                    },\r\n                    {\r\n                        "name": "Environment",\r\n                        "total": 3289698,\r\n                        "type": "NPC"\r\n                    },\r\n                    {\r\n                        "name": "Admiral Svirax",\r\n                        "total": 1674753,\r\n                        "totalReduced": 1418863,\r\n                        "type": "Boss"\r\n                    }\r\n                ]\r\n            },\r\n            "healing": {\r\n                "total": 4316062,\r\n                "totalReduced": 4060172,\r\n                "activeTime": 0,\r\n                "activeTimeReduced": 0,\r\n                "abilities": [\r\n                    {\r\n                        "name": "Hand of the Protector",\r\n                        "total": 2759311,\r\n                        "type": 2\r\n                    },\r\n                    {\r\n                        "name": "Vampiric Touch",\r\n                        "total": 764862,\r\n                        "type": 32\r\n                    },\r\n                    {\r\n                        "name": "Mental Fortitude",\r\n                        "total": 255890,\r\n                        "totalReduced": 0,\r\n                        "type": 1\r\n                    },\r\n                    {\r\n                        "name": "Ysera\'s Gift",\r\n                        "total": 182439,\r\n                        "type": 8\r\n                    },\r\n                    {\r\n                        "name": "Dreamer",\r\n                        "total": 140700,\r\n                        "type": 8\r\n                    }\r\n                ],\r\n                "damageAbilities": [\r\n                    {\r\n                        "name": "Entropic Blast",\r\n                        "total": 2933914,\r\n                        "type": 4\r\n                    },\r\n                    {\r\n                        "name": "Shock Grenade",\r\n                        "total": 842070,\r\n                        "totalReduced": 586180,\r\n                        "type": 4\r\n                    },\r\n                    {\r\n                        "name": "Entropic Blast",\r\n                        "total": 540078,\r\n                        "type": 4\r\n                    }\r\n                ],\r\n                "sources": [\r\n                    {\r\n                        "name": "X\\u00e9nubis",\r\n                        "total": 2777278,\r\n                        "type": "Paladin"\r\n                    },\r\n                    {\r\n                        "name": "Raek\\u00f3n",\r\n                        "total": 1020752,\r\n                        "totalReduced": 764862,\r\n                        "type": "Priest"\r\n                    },\r\n                    {\r\n                        "name": "Flucloxx",\r\n                        "total": 323139,\r\n                        "type": "Druid"\r\n                    },\r\n                    {\r\n                        "name": "Arciryas",\r\n                        "total": 194893,\r\n                        "type": "Monk"\r\n                    }\r\n                ]\r\n            },\r\n            "fight": 13,\r\n            "deathWindow": 5102,\r\n            "overkill": 1978916,\r\n            "events": [\r\n                {\r\n                    "timestamp": 2396629,\r\n                    "type": "damage",\r\n                    "source": {\r\n                        "name": "Environment",\r\n                        "id": -1,\r\n                        "guid": 0,\r\n                        "type": "NPC",\r\n                        "icon": "NPC-warcraft-0"\r\n                    },\r\n                    "sourceIsFriendly": false,\r\n                    "targetID": 5,\r\n                    "targetIsFriendly": true,\r\n                    "ability": {\r\n                        "name": "Shocked",\r\n                        "guid": 244748,\r\n                        "type": 4,\r\n                        "abilityIcon": "ability_monk_cracklingjadelightning.jpg"\r\n                    },\r\n                    "hitType": 1,\r\n                    "amount": 1310782,\r\n                    "overkill": 1978916,\r\n                    "absorbed": 0\r\n                },\r\n                {\r\n                    "timestamp": 2396525,\r\n                    "type": "damage",\r\n                    "sourceID": 111,\r\n                    "sourceInstance": 23,\r\n                    "sourceIsFriendly": false,\r\n                    "targetID": 5,\r\n                    "targetIsFriendly": true,\r\n                    "ability": {\r\n                        "name": "Entropic Blast",\r\n                        "guid": 253290,\r\n                        "type": 4,\r\n                        "abilityIcon": "spell_fire_felflamering.jpg"\r\n                    },\r\n                    "hitType": 1,\r\n                    "amount": 811023,\r\n                    "absorbed": 0,\r\n                    "tick": true\r\n                },\r\n                {\r\n                    "timestamp": 2396199,\r\n                    "type": "damage",\r\n                    "sourceID": 111,\r\n                    "sourceInstance": 17,\r\n                    "sourceIsFriendly": false,\r\n                    "targetID": 5,\r\n                    "targetIsFriendly": true,\r\n                    "ability": {\r\n                        "name": "Entropic Blast",\r\n                        "guid": 245121,\r\n                        "type": 4,\r\n                        "abilityIcon": "spell_fire_felflamering.jpg"\r\n                    },\r\n                    "hitType": 1,\r\n                    "amount": 3041282,\r\n                    "absorbed": 0\r\n                }\r\n            ],\r\n            "killingBlow": {\r\n                "name": "Shocked",\r\n                "guid": 244748,\r\n                "type": 4,\r\n                "abilityIcon": "ability_monk_cracklingjadelightning.jpg"\r\n            }\r\n        },\r\n        {\r\n            "name": "Frankii",\r\n            "id": 8,\r\n            "guid": 68759558,\r\n            "type": "Shaman",\r\n            "icon": "Shaman-Elemental",\r\n            "timestamp": 2511778,\r\n            "damage": {\r\n                "total": 6951094,\r\n                "activeTime": 0,\r\n                "activeTimeReduced": 0,\r\n                "abilities": [\r\n                    {\r\n                        "name": "Entropic Blast",\r\n                        "total": 3238485,\r\n                        "type": 4\r\n                    },\r\n                    {\r\n                        "name": "Chaos Pulse",\r\n                        "total": 2084136,\r\n                        "type": 4\r\n                    },\r\n                    {\r\n                        "name": "Shock Grenade",\r\n                        "total": 1628473,\r\n                        "type": 4\r\n                    }\r\n                ],\r\n                "damageAbilities": [],\r\n                "sources": [\r\n                    {\r\n                        "name": "Entropic Mine",\r\n                        "total": 3238485,\r\n                        "type": "NPC"\r\n                    },\r\n                    {\r\n                        "name": "Admiral Svirax",\r\n                        "total": 2084136,\r\n                        "type": "NPC"\r\n                    },\r\n                    {\r\n                        "name": "General Erodus",\r\n                        "total": 1628473,\r\n                        "type": "Boss"\r\n                    }\r\n                ]\r\n            },\r\n            "healing": {\r\n                "total": 306680,\r\n                "activeTime": 0,\r\n                "activeTimeReduced": 0,\r\n                "abilities": [\r\n                    {\r\n                        "name": "Rejuvenation",\r\n                        "total": 112827,\r\n                        "type": 8\r\n                    },\r\n                    {\r\n                        "name": "Rejuvenation (Germination)",\r\n                        "total": 98630,\r\n                        "type": 8\r\n                    },\r\n                    {\r\n                        "name": "Judgment of Light",\r\n                        "total": 58344,\r\n                        "type": 2\r\n                    },\r\n                    {\r\n                        "name": "Essence Font",\r\n                        "total": 36879,\r\n                        "type": 8\r\n                    }\r\n                ],\r\n                "damageAbilities": [\r\n                    {\r\n                        "name": "Chaos Pulse",\r\n                        "total": 306680,\r\n                        "type": 4\r\n                    }\r\n                ],\r\n                "sources": [\r\n                    {\r\n                        "name": "Flucloxx",\r\n                        "total": 211457,\r\n                        "type": "Druid"\r\n                    },\r\n                    {\r\n                        "name": "X\\u00e9nubis",\r\n                        "total": 58344,\r\n                        "type": "Paladin"\r\n                    },\r\n                    {\r\n                        "name": "Arciryas",\r\n                        "total": 36879,\r\n                        "type": "Monk"\r\n                    }\r\n                ]\r\n            },\r\n            "fight": 13,\r\n            "deathWindow": 2311,\r\n            "overkill": 76214,\r\n            "events": [\r\n                {\r\n                    "timestamp": 2511729,\r\n                    "type": "damage",\r\n                    "sourceID": 111,\r\n                    "sourceInstance": 49,\r\n                    "sourceIsFriendly": false,\r\n                    "targetID": 8,\r\n                    "targetIsFriendly": true,\r\n                    "ability": {\r\n                        "name": "Entropic Blast",\r\n                        "guid": 245121,\r\n                        "type": 4,\r\n                        "abilityIcon": "spell_fire_felflamering.jpg"\r\n                    },\r\n                    "hitType": 1,\r\n                    "amount": 3162271,\r\n                    "overkill": 76214,\r\n                    "absorbed": 0\r\n                },\r\n                {\r\n                    "timestamp": 2511597,\r\n                    "type": "damage",\r\n                    "sourceID": 118,\r\n                    "sourceInstance": 1,\r\n                    "sourceIsFriendly": false,\r\n                    "targetID": 8,\r\n                    "targetIsFriendly": true,\r\n                    "ability": {\r\n                        "name": "Chaos Pulse",\r\n                        "guid": 257974,\r\n                        "type": 4,\r\n                        "abilityIcon": "spell_fire_felpyroblast.jpg"\r\n                    },\r\n                    "hitType": 1,\r\n                    "amount": 259263,\r\n                    "absorbed": 0\r\n                },\r\n                {\r\n                    "timestamp": 2511405,\r\n                    "type": "damage",\r\n                    "sourceID": 118,\r\n                    "sourceInstance": 1,\r\n                    "sourceIsFriendly": false,\r\n                    "targetID": 8,\r\n                    "targetIsFriendly": true,\r\n                    "ability": {\r\n                        "name": "Chaos Pulse",\r\n                        "guid": 257974,\r\n                        "type": 4,\r\n                        "abilityIcon": "spell_fire_felpyroblast.jpg"\r\n                    },\r\n                    "hitType": 1,\r\n                    "amount": 260126,\r\n                    "absorbed": 0\r\n                }\r\n            ],\r\n            "killingBlow": {\r\n                "name": "Entropic Blast",\r\n                "guid": 245121,\r\n                "type": 4,\r\n                "abilityIcon": "spell_fire_felflamering.jpg"\r\n            }\r\n        },\r\n        {\r\n            "name": "Colossal",\r\n            "id": 47,\r\n            "guid": 68186179,\r\n            "type": "Warrior",\r\n            "icon": "Warrior-Fury",\r\n            "timestamp": 2690907,\r\n            "damage": {\r\n                "total": 0,\r\n                "activeTime": 0,\r\n                "activeTimeReduced": 0,\r\n                "abilities": [],\r\n                "damageAbilities": [],\r\n                "sources": []\r\n            },\r\n            "healing": {\r\n                "total": 0,\r\n                "activeTime": 0,\r\n                "activeTimeReduced": 0,\r\n                "abilities": [],\r\n                "damageAbilities": [],\r\n                "sources": []\r\n            },\r\n            "fight": 13,\r\n            "deathWindow": 0,\r\n            "overkill": 0,\r\n            "events": [\r\n                {\r\n                    "timestamp": 2690907,\r\n                    "type": "instakill",\r\n                    "sourceID": 47,\r\n                    "sourceIsFriendly": true,\r\n                    "targetID": 47,\r\n                    "targetIsFriendly": true,\r\n                    "ability": {\r\n                        "name": "Gaze of the Val\'kyr",\r\n                        "guid": 218834,\r\n                        "type": 1,\r\n                        "abilityIcon": "ability_warrior_weaponmastery.jpg"\r\n                    }\r\n                }\r\n            ],\r\n            "killingBlow": {\r\n                "name": "Gaze of the Val\'kyr",\r\n                "guid": 218834,\r\n                "type": 1,\r\n                "abilityIcon": "ability_warrior_weaponmastery.jpg"\r\n            }\r\n        }\r\n    ]\r\n}');

        mockBackend.connections.subscribe((connection: MockConnection) => {
            let body = {};
            if (connection.request.url.indexOf(`report/tables/deaths/${report.id}?api_key=${apiKey}&start=${fightInfo.start_time}&end=${fightInfo.end_time}`) !== -1) {
                body = expectedResponse;
            }

            connection.mockRespond(new Response(new ResponseOptions({
                body: body
            })));
        });

        const service = new WarcraftLogsDeathService(http, url, apiKey);
        
        service.getDeaths(report, fightInfo).subscribe(deaths => {
            expect(deaths).toBe(expectedResponse.entries);
        });
    })));
});
